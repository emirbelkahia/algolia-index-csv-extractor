<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Algolia Index CSV Extractor</title>
    <!-- Include Tailwind CSS from CDN -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 py-8">

<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
    <!-- Header -->
    <div class="text-center mb-6">
        <h1 class="text-3xl font-bold text-gray-900">Algolia Index CSV Extractor</h1>
        <p class="mt-2 text-sm text-gray-600">
            Built by <a href="https://www.linkedin.com/in/emirbelkahia/" class="text-indigo-600 hover:text-indigo-500">Emir Belkahia</a>, CSM at Algolia (2024). Not an official Algolia product.
        </p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Left column: Info boxes -->
        <div class="lg:col-span-1 space-y-4">
            <div class="bg-blue-50 border-l-4 border-blue-400 p-3">
                <h3 class="text-sm font-medium text-blue-800 mb-2">What it does</h3>
                <p class="text-xs text-blue-700">Extracts <strong>one attribute</strong> (e.g., SKU) from all hits returned by an empty query.</p>
            </div>

            <div class="bg-green-50 border-l-4 border-green-400 p-3">
                <h3 class="text-sm font-medium text-green-800 mb-2">Main use case</h3>
                <p class="text-xs text-green-700"><strong>Merchandising troubleshooting:</strong> Verify that your complete product offering is indexed for a given rule context (promo, mobile, seasonal).</p>
            </div>

            <div class="bg-yellow-50 border-l-4 border-yellow-400 p-3">
                <h3 class="text-sm font-medium text-yellow-800 mb-2">Limitation</h3>
                <p class="text-xs text-yellow-700">Max 10,000 hits (pagination limit).</p>
            </div>
        </div>

        <!-- Right column: Form -->
        <div class="lg:col-span-2">
            <div class="bg-white shadow rounded-lg p-6">
                <h2 class="text-lg font-semibold text-gray-900 mb-4">Extract attribute to CSV</h2>
        <form class="space-y-4" id="algolia-form">
            <input type="hidden" name="remember" value="true">
            <div class="rounded-md shadow-sm -space-y-px">
                <div>
                    <label for="application-id" class="sr-only">Application ID</label>
                    <input id="application-id" name="application_id" type="text" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-t-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm" placeholder="Application ID">
                </div>
                <div>
                    <label for="api-key" class="sr-only">API Key</label>
                    <input id="api-key" name="api_key" type="text" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm" placeholder="API Key">
                </div>
                <div>
                    <label for="index-name" class="sr-only">Index Name</label>
                    <input id="index-name" name="index_name" type="text" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm" placeholder="Index Name">
                </div>
                <div>
                    <label for="rule-context" class="sr-only">Rule Context (optional)</label>
                    <input id="rule-context" name="rule_context" type="text" class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm" placeholder="Rule Context (optional)">
                </div>
                <div>
                    <label for="attribute-name" class="sr-only">Attribute to Extract</label>
                    <input id="attribute-name" name="attribute_name" type="text" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-b-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm" placeholder="Attribute to extract (e.g., objectID, name, sku)">
                </div>
            </div>

            <div>
                <button type="submit" class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    Submit
                </button>
            </div>
        </form>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/algoliasearch@3.35.1/dist/algoliasearch.min.js"></script>
<script>
console.log('Script loaded!');
console.log('algoliasearch available?', typeof algoliasearch);

document.getElementById('algolia-form').addEventListener('submit', function(event) {
  event.preventDefault();
  console.log("Form submission intercepted!");

  const applicationId = document.getElementById('application-id').value;
  const apiKey = document.getElementById('api-key').value;
  const indexName = document.getElementById('index-name').value;
  const ruleContextInput = document.getElementById('rule-context').value;
  const ruleContexts = ruleContextInput ? [ruleContextInput] : [];
  const attributeName = document.getElementById('attribute-name').value;

  console.log('Values:', { applicationId, apiKey, indexName, attributeName });

  if (!applicationId || !apiKey || !indexName || !attributeName) {
    alert('Please fill in all required fields');
    return;
  }

  const client = algoliasearch(applicationId, apiKey);
  const index = client.initIndex(indexName);

  let allHits = [];
  const maxPages = 10;
  let page = 0;

  const fetchPage = () => {
    console.log(`Fetching page ${page + 1}...`);
    index.search('', {
      ruleContexts: ruleContexts,
      hitsPerPage: 1000,
      page: page
    })
    .then(({ hits, nbPages }) => {
      console.log(`Page ${page + 1} completed: ${hits.length} hits`);
      allHits = allHits.concat(hits);
      if (page < nbPages - 1 && page < maxPages - 1) {
        page++;
        fetchPage();
      } else {
        console.log(`Total hits: ${allHits.length}`);
        displayResults(allHits, attributeName);
      }
    })
    .catch(error => {
      console.error("Search failed:", error);
      alert('Search failed: ' + error.message);
    });
  };

  fetchPage();
});

function displayResults(hits, attributeName) {
  const existingContainer = document.getElementById('results-container');
  if (existingContainer) {
    existingContainer.remove();
  }

  const resultsContainer = document.createElement('div');
  resultsContainer.id = 'results-container';
  resultsContainer.className = 'flex flex-col items-center justify-center w-full mt-8';

  const numReferences = document.createElement('div');
  numReferences.className = 'text-lg font-semibold my-4';
  numReferences.textContent = `Number of Hits: ${hits.length}`;
  resultsContainer.appendChild(numReferences);

  const table = document.createElement('table');
  table.className = 'min-w-full divide-y divide-gray-200 shadow overflow-hidden border-b border-gray-200 sm:rounded-lg';
  const thead = document.createElement('thead');
  thead.className = 'bg-gray-50';
  const trHead = document.createElement('tr');
  const th = document.createElement('th');
  th.textContent = attributeName;
  th.className = 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider';
  trHead.appendChild(th);
  thead.appendChild(trHead);
  table.appendChild(thead);

  const tbody = document.createElement('tbody');
  tbody.className = 'bg-white divide-y divide-gray-200';
  hits.forEach(hit => {
    const tr = document.createElement('tr');
    const td = document.createElement('td');
    td.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-500';
    td.textContent = hit[attributeName] || '(empty)';
    tr.appendChild(td);
    tbody.appendChild(tr);
  });
  table.appendChild(tbody);

  resultsContainer.appendChild(table);

  const downloadButton = document.createElement('button');
  downloadButton.textContent = 'Download CSV';
  downloadButton.className = 'mt-4 mb-8 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline transition ease-in-out duration-150';
  downloadButton.onclick = () => downloadCSV(hits, attributeName);
  resultsContainer.appendChild(downloadButton);

  document.body.appendChild(resultsContainer);
  resultsContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function downloadCSV(hits, attributeName) {
  const now = new Date();
  const dateString = now.toISOString().split('T')[0];
  const timeString = now.toTimeString().split(' ')[0].replace(/:/g, '-');
  const ruleContext = document.getElementById('rule-context').value || 'no-context';
  const filename = `algolia_export_${attributeName}_${dateString}_${timeString}_${ruleContext}.csv`;

  const csvContent = "data:text/csv;charset=utf-8," + hits.map(e =>
    `"${e[attributeName] || ''}"`
  ).join("\n");
  const encodedUri = encodeURI(csvContent);
  const link = document.createElement("a");
  link.setAttribute("href", encodedUri);
  link.setAttribute("download", filename);
  document.body.appendChild(link);
  link.click();
  link.remove();
}
</script>

</body>
</html>
